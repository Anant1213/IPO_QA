<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPO Intelligence Platform</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #111111;
            --bg-tertiary: #1a1a1a;
            --border-subtle: rgba(255, 255, 255, 0.06);
            --border-medium: rgba(255, 255, 255, 0.1);
            --text-primary: #ffffff;
            --text-secondary: #a1a1aa;
            --text-tertiary: #71717a;
            --accent-primary: #3b82f6;
            --accent-secondary: #8b5cf6;
            --success: #10b981;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                linear-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
            z-index: 0;
        }

        .app {
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .nav {
            border-bottom: 1px solid var(--border-subtle);
            background: rgba(10, 10, 10, 0.8);
            backdrop-filter: blur(20px);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-content {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 24px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 15px;
            font-weight: 600;
            letter-spacing: -0.02em;
        }

        .logo-mark {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .nav-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-tabs {
            display: flex;
            gap: 4px;
        }

        .nav-tab {
            padding: 6px 12px;
            background: transparent;
            border: none;
            color: var(--text-tertiary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.15s;
        }

        .nav-tab:hover {
            color: var(--text-secondary);
            background: rgba(255, 255, 255, 0.05);
        }

        .nav-tab.active {
            color: var(--text-primary);
            background: var(--bg-tertiary);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            color: var(--success);
        }

        .status-dot {
            width: 6px;
            height: 6px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.4;
            }
        }

        .main {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .sidebar {
            width: 280px;
            border-right: 1px solid var(--border-subtle);
            background: var(--bg-secondary);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .sidebar-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-tertiary);
            margin-bottom: 12px;
        }

        .document-select {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-medium);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 13px;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .document-select:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .document-select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .sidebar-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .sidebar-content::-webkit-scrollbar {
            width: 4px;
        }

        .sidebar-content::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
        }

        .sidebar-section {
            margin-bottom: 24px;
        }

        .suggested-questions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .suggested-question {
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            font-size: 12px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s;
            text-align: left;
        }

        .suggested-question:hover {
            border-color: var(--accent-primary);
            color: var(--text-primary);
            background: rgba(59, 130, 246, 0.05);
        }

        .metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .metric {
            padding: 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
        }

        .metric-value {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.02em;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .metric-label {
            font-size: 11px;
            color: var(--text-tertiary);
            margin-top: 4px;
            font-weight: 500;
        }

        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid var(--border-subtle);
        }

        .status-text {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
        }

        .tab-content {
            display: none;
            flex: 1;
            flex-direction: column;
            overflow: hidden;
        }

        .tab-content.active {
            display: flex;
        }

        .chat-header {
            padding: 20px 32px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .chat-title {
            font-size: 14px;
            font-weight: 600;
        }

        .chat-subtitle {
            font-size: 13px;
            color: var(--text-tertiary);
            margin-top: 2px;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 32px;
            min-height: 0;
        }

        .messages::-webkit-scrollbar {
            width: 6px;
        }

        .messages::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .message {
            margin-bottom: 24px;
            animation: messageIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes messageIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .message-avatar {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
        }

        .user-message .message-avatar {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        .assistant-message .message-avatar {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }

        .message-author {
            font-size: 13px;
            font-weight: 600;
        }

        .message-content {
            padding-left: 34px;
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-secondary);
        }

        .user-message .message-content {
            color: var(--text-primary);
        }

        .follow-up-questions {
            padding-left: 34px;
            margin-top: 12px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .follow-up-btn {
            padding: 8px 12px;
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 6px;
            color: var(--accent-secondary);
            font-size: 12px;
            text-align: left;
            cursor: pointer;
            transition: all 0.15s;
        }

        .follow-up-btn:hover {
            background: rgba(139, 92, 246, 0.15);
            border-color: var(--accent-secondary);
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
        }

        .empty-icon {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            margin-bottom: 20px;
        }

        .empty-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            letter-spacing: -0.01em;
        }

        .empty-description {
            font-size: 14px;
            color: var(--text-tertiary);
            max-width: 400px;
            line-height: 1.5;
        }

        .summary-panel {
            flex: 1;
            overflow-y: auto;
            padding: 32px;
        }

        .summary-panel::-webkit-scrollbar {
            width: 6px;
        }

        .summary-panel::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .summary-grid {
            display: grid;
            gap: 20px;
            max-width: 1000px;
        }

        .summary-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 24px;
        }

        .summary-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .summary-card-title {
            font-size: 16px;
            font-weight: 600;
        }

        .summary-card-content {
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-secondary);
        }

        .summary-card-content ul,
        .message-content ul {
            list-style: none;
            padding-left: 0;
            margin: 12px 0;
        }

        .summary-card-content li,
        .message-content li {
            padding-left: 20px;
            margin-bottom: 8px;
            position: relative;
        }

        .summary-card-content li:before,
        .message-content li:before {
            content: 'â€¢';
            position: absolute;
            left: 0;
            color: var(--accent-primary);
            font-weight: bold;
        }

        .summary-card-content strong,
        .message-content strong {
            color: var(--text-primary);
            font-weight: 600;
        }

        .generate-btn {
            padding: 10px 16px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .generate-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .generate-btn:disabled {
            background: var(--bg-tertiary);
            color: var(--text-tertiary);
            cursor: not-allowed;
            transform: none;
        }

        .chart-container {
            margin-top: 16px;
            padding: 16px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            max-width: 500px;
        }

        .input-area {
            padding: 20px 32px 24px;
            border-top: 1px solid var(--border-subtle);
        }

        .input-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        #questionInput {
            flex: 1;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-medium);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
            transition: all 0.15s;
        }

        #questionInput:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            background: var(--bg-tertiary);
        }

        #questionInput::placeholder {
            color: var(--text-tertiary);
        }

        #sendBtn {
            padding: 12px 20px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.15s;
        }

        #sendBtn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        #sendBtn:active {
            transform: translateY(0);
        }

        #sendBtn:disabled {
            background: var(--bg-tertiary);
            color: var(--text-tertiary);
            cursor: not-allowed;
            transform: none;
        }

        .input-hint {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-top: 8px;
            text-align: center;
        }
    </style>
</head>

<body>
    <div class="app">
        <nav class="nav">
            <div class="nav-content">
                <div class="logo">
                    <div class="logo-mark">ðŸ“Š</div>
                    <span>IPO Intelligence</span>
                </div>
                <div class="nav-actions">
                    <div class="nav-tabs">
                        <button class="nav-tab active" onclick="switchTab('chat')">Chat</button>
                        <button class="nav-tab" onclick="switchTab('summary')">Summary</button>
                    </div>
                    <div class="status-indicator">
                        <div class="status-dot"></div>
                        <span>Online</span>
                    </div>
                </div>
            </div>
        </nav>

        <div class="main">
            <aside class="sidebar">
                <div class="sidebar-header">
                    <div class="sidebar-title">Document</div>
                    <select id="documentSelect" class="document-select">
                        <option value="">Loading...</option>
                    </select>
                </div>

                <div class="sidebar-content">
                    <div class="sidebar-section">
                        <div class="sidebar-title">Upload Document</div>
                        <input type="file" id="fileUpload" accept=".pdf" style="display: none;"
                            onchange="handleFileUpload(event)">
                        <button class="generate-btn" style="width: 100%; margin-bottom: 0;"
                            onclick="document.getElementById('fileUpload').click()">
                            ðŸ“„ Upload PDF
                        </button>
                    </div>

                    <div class="sidebar-section">
                        <div class="sidebar-title">Suggested Questions</div>
                        <div class="suggested-questions">
                            <!-- Questions will be dynamically loaded -->
                        </div>
                    </div>

                    <div class="sidebar-section">
                        <div class="sidebar-title">Analytics</div>
                        <div class="metrics">
                            <div class="metric">
                                <div class="metric-value" id="queryCount">0</div>
                                <div class="metric-label">Queries</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value" id="docCount">0</div>
                                <div class="metric-label">Documents</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="sidebar-footer">
                    <div class="status-text" id="status">Ready to analyze</div>
                </div>
            </aside>

            <main class="chat">
                <!-- Chat Tab -->
                <div id="chatTab" class="tab-content active">
                    <div class="chat-header">
                        <div class="chat-title">AI Document Analysis</div>
                        <div class="chat-subtitle">Ask questions and get instant insights</div>
                    </div>

                    <div class="messages" id="chatBox">
                        <div class="empty-state">
                            <div class="empty-icon">ðŸ’¬</div>
                            <div class="empty-title">Start analyzing</div>
                            <div class="empty-description">
                                Select a document and ask questions or use suggested questions to get started.
                            </div>
                        </div>
                    </div>

                    <div class="input-area">
                        <div class="input-container">
                            <div class="input-wrapper">
                                <input type="text" id="questionInput"
                                    placeholder="Ask anything about the document..." />
                                <button id="sendBtn">Send</button>
                            </div>
                            <div class="input-hint">Press Enter to send</div>
                        </div>
                    </div>
                </div>

                <!-- Summary Tab -->
                <div id="summaryTab" class="tab-content">
                    <div class="chat-header">
                        <div class="chat-title">Smart Summary</div>
                        <div class="chat-subtitle">One-click executive insights</div>
                    </div>

                    <div class="summary-panel">
                        <div class="summary-grid" id="summaryGrid">
                            <div class="empty-state">
                                <div class="empty-icon">ðŸ“‹</div>
                                <div class="empty-title">Generate Summary</div>
                                <div class="empty-description">
                                    Select a document and click generate to get executive summary, risk assessment, and
                                    key metrics.
                                </div>
                                <button class="generate-btn" style="margin-top: 20px;" onclick="generateSummary()">
                                    Generate Summary
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        let currentDocumentId = null;
        let queryCount = 0;
        let currentTab = 'chat';
        let askedQuestions = new Set();

        // Full pool of suggested questions
        const questionPool = [
            'What are the top 3 risk factors?',
            'Summarize the business model and revenue streams',
            'How will the proceeds be used?',
            'What are the key financial metrics?',
            'Who are the major shareholders?',
            'What is the company\'s competitive advantage?',
            'What are the growth projections?',
            'Who are the main competitors?',
            'What is the market size and opportunity?',
            'What are the regulatory risks?',
            'What is the pricing strategy?',
            'What are the historical financial trends?',
            'What is the management team\'s background?',
            'What are the use of proceeds priorities?',
            'What are the key performance indicators?'
        ];

        function getRandomQuestions(count) {
            // Get questions that haven't been asked yet
            const availableQuestions = questionPool.filter(q => !askedQuestions.has(q));

            // If we've asked too many, reset
            if (availableQuestions.length < count) {
                askedQuestions.clear();
                return questionPool.slice(0, count);
            }

            // Shuffle and return random questions
            const shuffled = availableQuestions.sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }

        function updateSuggestedQuestions() {
            const container = document.querySelector('.suggested-questions');
            const questions = getRandomQuestions(5);

            container.innerHTML = '';
            questions.forEach(q => {
                const btn = document.createElement('button');
                btn.className = 'suggested-question';
                btn.textContent = q;
                btn.onclick = () => askQuestion(q);
                container.appendChild(btn);
            });
        }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');
        }

        function askQuestion(question) {
            if (!currentDocumentId) {
                setStatus('Please select a document first');
                return;
            }

            // Mark question as asked and update suggestions
            askedQuestions.add(question);
            updateSuggestedQuestions();

            // Switch to chat tab
            if (currentTab !== 'chat') {
                document.querySelector('.nav-tab').click();
            }

            document.getElementById('questionInput').value = question;
            sendQuestion();
        }

        async function loadDocuments() {
            try {
                const response = await fetch('/api/documents');
                const data = await response.json();

                const select = document.getElementById('documentSelect');
                select.innerHTML = '<option value="">Select document...</option>';

                if (data.documents && data.documents.length > 0) {
                    data.documents.forEach(doc => {
                        const option = document.createElement('option');
                        option.value = doc.document_id;
                        option.textContent = doc.display_name;
                        select.appendChild(option);
                    });
                    document.getElementById('docCount').textContent = data.documents.length;
                    setStatus('Documents loaded');

                    // Initialize suggested questions
                    updateSuggestedQuestions();
                }
            } catch (error) {
                setStatus('Error loading documents');
            }
        }

        document.getElementById('documentSelect').addEventListener('change', (e) => {
            currentDocumentId = e.target.value;
            if (currentDocumentId) {
                setStatus('Document selected');
            }
        });

        document.getElementById('sendBtn').addEventListener('click', sendQuestion);

        document.getElementById('questionInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendQuestion();
            }
        });

        async function sendQuestion() {
            const input = document.getElementById('questionInput');
            const question = input.value.trim();

            if (!question) {
                setStatus('Please enter a question');
                return;
            }

            if (!currentDocumentId) {
                setStatus('Please select a document first');
                return;
            }

            const emptyState = document.querySelector('#chatBox .empty-state');
            if (emptyState) {
                emptyState.remove();
            }

            input.disabled = true;
            document.getElementById('sendBtn').disabled = true;

            addMessage(question, 'user');
            input.value = '';

            const assistantDiv = addMessage('Analyzing...', 'assistant');

            setStatus('Processing...');

            try {
                const response = await fetch('/api/ask', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question: question,
                        document_id: currentDocumentId
                    })
                });

                if (!response.ok) {
                    throw new Error('Server error');
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let fullText = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop();

                    for (const line of lines) {
                        if (!line.trim()) continue;

                        try {
                            const data = JSON.parse(line);

                            if (data.type === 'token') {
                                fullText += data.content;
                                assistantDiv.querySelector('.message-content').innerHTML = formatTextWithBullets(fullText);

                                // Try to extract and visualize financial data
                                tryExtractFinancialData(fullText, assistantDiv);
                            } else if (data.type === 'done') {
                                setStatus('Complete');
                                queryCount++;
                                document.getElementById('queryCount').textContent = queryCount;

                                // Add follow-up questions
                                addFollowUpQuestions(assistantDiv, question);
                            }
                        } catch (e) {
                            console.error('Parse error:', e);
                        }
                    }
                }

            } catch (error) {
                assistantDiv.querySelector('.message-content').textContent = 'Error: ' + error.message;
                setStatus('Error occurred');
            } finally {
                input.disabled = false;
                document.getElementById('sendBtn').disabled = false;
                input.focus();
            }
        }

        function tryExtractFinancialData(text, messageDiv) {
            // Simple pattern matching for financial data
            const revenueMatch = text.match(/revenue.*?(\d+(?:,\d+)*(?:\.\d+)?)\s*(million|billion|crore)/i);
            const profitMatch = text.match(/profit.*?(\d+(?:,\d+)*(?:\.\d+)?)\s*(million|billion|crore)/i);

            if ((revenueMatch || profitMatch) && !messageDiv.querySelector('.chart-container')) {
                // Only create chart once
                const chartDiv = document.createElement('div');
                chartDiv.className = 'chart-container';
                chartDiv.innerHTML = '<canvas id="chart-' + Date.now() + '"></canvas>';
                messageDiv.appendChild(chartDiv);

                // Create simple bar chart
                setTimeout(() => {
                    const canvas = chartDiv.querySelector('canvas');
                    new Chart(canvas, {
                        type: 'bar',
                        data: {
                            labels: ['Revenue', 'Profit'],
                            datasets: [{
                                label: 'Financial Metrics',
                                data: [
                                    revenueMatch ? parseFloat(revenueMatch[1].replace(/,/g, '')) : 0,
                                    profitMatch ? parseFloat(profitMatch[1].replace(/,/g, '')) : 0
                                ],
                                backgroundColor: [
                                    'rgba(59, 130, 246, 0.5)',
                                    'rgba(139, 92, 246, 0.5)'
                                ],
                                borderColor: [
                                    'rgba(59, 130, 246, 1)',
                                    'rgba(139, 92, 246, 1)'
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                    ticks: { color: '#a1a1aa' }
                                },
                                x: {
                                    grid: { display: false },
                                    ticks: { color: '#a1a1aa' }
                                }
                            }
                        }
                    });
                }, 100);
            }
        }

        function formatTextWithBullets(text) {
            // Convert numbered lists (1., 2., etc.) to bullet points
            let formatted = text.replace(/(\d+)\.\s+([^\n]+)/g, '<li>$2</li>');

            // If we found list items, wrap them in ul
            if (formatted.includes('<li>')) {
                formatted = formatted.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
            }

            // Convert double newlines to paragraphs
            formatted = formatted.split('\n\n').map(para => {
                if (!para.includes('<li>') && para.trim()) {
                    return '<p>' + para.trim() + '</p>';
                }
                return para;
            }).join('');

            // Make bold text stand out
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

            return formatted;
        }

        function addFollowUpQuestions(messageDiv, originalQuestion) {
            const followUpDiv = document.createElement('div');
            followUpDiv.className = 'follow-up-questions';

            // Generate contextual follow-ups based on the question
            let followUps = [];
            if (originalQuestion.toLowerCase().includes('risk')) {
                followUps = [
                    'What mitigation strategies are mentioned?',
                    'How do these risks compare to industry standards?'
                ];
            } else if (originalQuestion.toLowerCase().includes('financial') || originalQuestion.toLowerCase().includes('revenue')) {
                followUps = [
                    'What is the year-over-year growth rate?',
                    'What are the profit margins?'
                ];
            } else if (originalQuestion.toLowerCase().includes('business')) {
                followUps = [
                    'Who are the main competitors?',
                    'What is the market size?'
                ];
            } else {
                followUps = [
                    'Can you provide more details?',
                    'What are the implications?'
                ];
            }

            followUps.forEach(q => {
                const btn = document.createElement('button');
                btn.className = 'follow-up-btn';
                btn.textContent = 'ðŸ’¡ ' + q;
                btn.onclick = () => askQuestion(q);
                followUpDiv.appendChild(btn);
            });

            messageDiv.appendChild(followUpDiv);
        }

        async function generateSummary() {
            if (!currentDocumentId) {
                setStatus('Please select a document first');
                return;
            }

            const grid = document.getElementById('summaryGrid');
            grid.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 40px;">Generating comprehensive summary...</div>';

            const summaries = [
                { title: 'Executive Summary', question: 'Provide a comprehensive executive summary of this IPO in 3-4 paragraphs' },
                { title: 'Risk Assessment', question: 'List and explain the top 5 risk factors' },
                { title: 'Financial Highlights', question: 'Summarize key financial metrics, revenue, and profitability' }
            ];

            grid.innerHTML = '';

            // Process each summary sequentially to prevent breaking
            for (const summary of summaries) {
                const card = document.createElement('div');
                card.className = 'summary-card';
                card.innerHTML = `
                    <div class="summary-card-header">
                        <div class="summary-card-title">${summary.title}</div>
                    </div>
                    <div class="summary-card-content">Loading...</div>
                `;
                grid.appendChild(card);

                // Wait for this summary to complete before starting next
                try {
                    const response = await fetch('/api/ask', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            question: summary.question,
                            document_id: currentDocumentId
                        })
                    });

                    if (!response.ok) {
                        card.querySelector('.summary-card-content').textContent = 'Error loading summary';
                        continue;
                    }

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';
                    let fullText = '';

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop();

                        for (const line of lines) {
                            if (!line.trim()) continue;
                            try {
                                const data = JSON.parse(line);
                                if (data.type === 'token') {
                                    fullText += data.content;
                                    card.querySelector('.summary-card-content').innerHTML = formatTextWithBullets(fullText);
                                }
                            } catch (e) { }
                        }
                    }
                } catch (error) {
                    card.querySelector('.summary-card-content').textContent = 'Error loading summary';
                }
            }

            setStatus('Summary generation complete');
        }

        function addMessage(text, type) {
            const chatBox = document.getElementById('chatBox');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ' + type + '-message';

            const header = document.createElement('div');
            header.className = 'message-header';

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = type === 'user' ? 'U' : 'AI';

            const author = document.createElement('div');
            author.className = 'message-author';
            author.textContent = type === 'user' ? 'You' : 'Assistant';

            header.appendChild(avatar);
            header.appendChild(author);

            const content = document.createElement('div');
            content.className = 'message-content';
            content.textContent = text;

            messageDiv.appendChild(header);
            messageDiv.appendChild(content);
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;

            return messageDiv;
        }

        function setStatus(message) {
            document.getElementById('status').textContent = message;
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.endsWith('.pdf')) {
                setStatus('Please upload a PDF file');
                return;
            }

            setStatus('Uploading and processing document...');

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    setStatus('Document uploaded successfully!');
                    // Reload documents list
                    await loadDocuments();
                    // Select the newly uploaded document
                    document.getElementById('documentSelect').value = result.document_id;
                    currentDocumentId = result.document_id;
                } else {
                    setStatus('Error: ' + (result.error || 'Upload failed'));
                }
            } catch (error) {
                setStatus('Error uploading document');
            }

            // Reset file input
            event.target.value = '';
        }

        loadDocuments();
    </script>
</body>

</html>